<?php
/**
 * ZenScribe - Teste de Simula√ß√£o
 * Testa o fluxo completo com dados simulados
 */

// Inicializar sess√£o
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

require_once(__DIR__ . '/crest.php');
require_once(__DIR__ . '/settings.php');

// Headers
header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST, GET, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type');

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    exit(0);
}

$action = $_GET['action'] ?? $_POST['action'] ?? 'run_simulation';

switch ($action) {
    case 'run_simulation':
        runFullSimulation();
        break;
    case 'test_openai_only':
        testOpenAIExtraction();
        break;
    case 'test_bitrix_only':
        testBitrixUpdate();
        break;
    default:
        zenError('A√ß√£o n√£o reconhecida', ['action' => $action], 400);
}

/**
 * Executa simula√ß√£o completa do fluxo
 */
function runFullSimulation() {
    try {
        zenLog('üß™ Iniciando simula√ß√£o completa', 'info');
        
        // 1. Dados simulados da reuni√£o
        $meeting = [
            'title' => 'Reuni√£o Comercial - Proposta E-commerce',
            'description' => 'Reuni√£o com cliente sobre projeto de e-commerce. Lead: https://zopu.bitrix24.com.br/crm/lead/details/67890',
            'start_time' => date('c', strtotime('-1 hour')),
            'end_time' => date('c'),
            'participants' => ['joao@vendedor.com', 'cliente@empresa.com.br']
        ];
        
        // 2. Transcri√ß√£o simulada (comercial)
        $transcript = "Jo√£o: Boa tarde! Obrigado por aceitar nossa reuni√£o hoje.

Cliente: Oi Jo√£o, obrigado voc√™. Estamos muito interessados no projeto de e-commerce.

Jo√£o: Perfeito! Me conte um pouco sobre as principais dificuldades que voc√™s est√£o enfrentando hoje.

Cliente: Olha, nossa maior dor √© que nosso site atual √© muito lento, os clientes reclamam constantemente. Al√©m disso, n√£o temos integra√ß√£o com nosso estoque, ent√£o vendemos produtos que n√£o temos. √â muito frustrante.

Jo√£o: Entendo perfeitamente. E qual seria o or√ßamento que voc√™s t√™m em mente para resolver isso?

Cliente: Estamos pensando em investir entre R$ 80.000 a R$ 120.000 para ter uma solu√ß√£o completa.

Jo√£o: √ìtimo! E quais s√£o os seus principais desejos para a nova plataforma?

Cliente: Queremos um site super r√°pido, integra√ß√£o total com estoque, sistema de pagamento moderno, painel administrativo intuitivo e que seja responsivo no mobile.

Jo√£o: Perfeito! Baseado no que voc√™s me falaram, eu vou preparar uma proposta detalhada. Acredito que podemos entregar tudo isso em aproximadamente 120 horas de desenvolvimento.

Cliente: Quanto tempo seria isso?

Jo√£o: Cerca de 3 meses de trabalho. E me diga, o que voc√™s N√ÉO querem que esteja inclu√≠do no escopo?

Cliente: N√£o queremos marketing digital, n√£o queremos app mobile por enquanto, e n√£o precisamos de integra√ß√£o com redes sociais.

Jo√£o: Perfeito! Vou agendar uma pr√≥xima reuni√£o para apresentar a proposta. Que tal semana que vem?

Cliente: Perfeito, Jo√£o! Aguardo ansiosamente.";
        
        // 3. Detectar entidade Bitrix24
        $entity = detectBitrixEntity($meeting['description']);
        if (!$entity) {
            $entity = ['type' => 'lead', 'id' => 67890]; // Entidade simulada
        }
        
        zenLog('üìä Entidade detectada', 'info', $entity);
        
        // 4. Processar transcri√ß√£o com OpenAI
        $extractedData = processTranscriptSimulation($transcript);
        
        // 5. Simular atualiza√ß√£o Bitrix24
        $bitrixResult = simulateBitrixUpdate($entity, $extractedData, $meeting, $transcript);
        
        // 6. Simular cria√ß√£o de atividade
        $activityResult = simulateRichActivity($entity, $extractedData, $meeting, $transcript);
        
        // 7. Agendamento autom√°tico
        $schedulingResult = simulateScheduling($transcript, $meeting, $extractedData);
        
        zenLog('‚úÖ Simula√ß√£o completa conclu√≠da', 'info');
        
        zenSuccess([
            'simulation' => 'complete',
            'steps' => [
                'meeting_data' => $meeting,
                'entity_detected' => $entity,
                'extracted_data' => $extractedData,
                'bitrix_result' => $bitrixResult,
                'activity_result' => $activityResult,
                'scheduling_result' => $schedulingResult
            ],
            'summary' => [
                'entity_type' => $entity['type'],
                'entity_id' => $entity['id'],
                'openai_used' => !empty($extractedData['ai_processed']),
                'scheduling_detected' => $schedulingResult['scheduled']
            ]
        ], 'Simula√ß√£o completa executada com sucesso!');
        
    } catch (Exception $e) {
        zenError('Erro na simula√ß√£o: ' . $e->getMessage(), ['trace' => $e->getTraceAsString()]);
    }
}

/**
 * Processa transcri√ß√£o (vers√£o simulada que chama OpenAI real)
 */
function processTranscriptSimulation($transcript) {
    $config = getZenScribeConfig();
    
    // Se OpenAI est√° habilitado, usar IA real
    if (!empty($config['openai']['api_key']) && $config['openai']['enabled']) {
        return extractDataWithOpenAI($transcript);
    }
    
    // Sen√£o, usar dados heur√≠sticos simulados
    return [
        'ai_processed' => false,
        'method' => 'heuristic_simulation',
        'TITLE' => 'Reuni√£o Comercial - Proposta E-commerce',
        'OPPORTUNITY' => '100000',
        'COMMENTS' => 'DORES IDENTIFICADAS:\n‚Ä¢ Site lento com reclama√ß√µes de clientes\n‚Ä¢ Falta de integra√ß√£o com estoque\n‚Ä¢ Vendas de produtos indispon√≠veis\n\nDESEJOS DO CLIENTE:\n‚Ä¢ Site super r√°pido\n‚Ä¢ Integra√ß√£o total com estoque\n‚Ä¢ Sistema de pagamento moderno\n‚Ä¢ Painel administrativo intuitivo\n‚Ä¢ Design responsivo mobile\n\nESTIMATIVA: 120 horas de desenvolvimento (3 meses)\n\nESCOPO NEGATIVO:\n‚Ä¢ Marketing digital\n‚Ä¢ App mobile\n‚Ä¢ Integra√ß√£o redes sociais',
        'urgency' => 'alta',
        'next_steps' => ['Preparar proposta detalhada', 'Agendar reuni√£o de apresenta√ß√£o'],
        'pain_points' => [
            'Site atual muito lento',
            'Falta integra√ß√£o com estoque',
            'Vendas sem controle de disponibilidade',
            'Experi√™ncia do cliente prejudicada'
        ],
        'desires' => [
            'Performance superior',
            'Integra√ß√£o completa',
            'Pagamentos modernos',
            'Interface intuitiva',
            'Mobile responsivo'
        ]
    ];
}

/**
 * Simula atualiza√ß√£o no Bitrix24
 */
function simulateBitrixUpdate($entity, $extractedData, $meeting, $transcript) {
    // Em modo simula√ß√£o, apenas logar o que seria feito
    $fields = [
        'TITLE' => $extractedData['TITLE'] ?? $meeting['title'],
        'OPPORTUNITY' => $extractedData['OPPORTUNITY'] ?? '',
        'COMMENTS' => $extractedData['COMMENTS'] ?? substr($transcript, 0, 500) . '...'
    ];
    
    zenLog('üîÑ Simulando atualiza√ß√£o Bitrix24', 'info', [
        'entity_type' => $entity['type'],
        'entity_id' => $entity['id'],
        'fields' => $fields
    ]);
    
    return [
        'simulated' => true,
        'would_update' => $entity['type'] . '.update',
        'entity_id' => $entity['id'],
        'fields' => $fields,
        'success' => true
    ];
}

/**
 * Simula cria√ß√£o de atividade rica
 */
function simulateRichActivity($entity, $extractedData, $meeting, $transcript) {
    $activity = [
        'OWNER_TYPE_ID' => ($entity['type'] === 'lead') ? 1 : 2,
        'OWNER_ID' => $entity['id'],
        'TYPE_ID' => 6,
        'SUBJECT' => 'üéØ ZenScribe: ' . ($extractedData['TITLE'] ?? $meeting['title']),
        'DESCRIPTION' => $extractedData['COMMENTS'] ?? $transcript,
        'COMPLETED' => 'Y',
        'RESPONSIBLE_ID' => 1
    ];
    
    zenLog('üìù Simulando atividade rica', 'info', $activity);
    
    return [
        'simulated' => true,
        'would_create' => 'crm.activity.add',
        'activity_data' => $activity,
        'success' => true
    ];
}

/**
 * Simula agendamento autom√°tico
 */
function simulateScheduling($transcript, $meeting, $extractedData) {
    // Detectar se precisa agendar
    if (!preg_match('/(?:pr√≥xim|agendar|reuni√£o|encontro|semana que vem)/i', $transcript)) {
        return ['scheduled' => false, 'reason' => 'no_follow_up_detected'];
    }
    
    $nextDate = date('Y-m-d H:i:s', strtotime('+7 days'));
    
    zenLog('üìÖ Simulando agendamento', 'info', [
        'next_date' => $nextDate,
        'title' => 'Follow-up: Apresenta√ß√£o de Proposta'
    ]);
    
    return [
        'scheduled' => true,
        'simulated' => true,
        'date' => $nextDate,
        'title' => 'Follow-up: Apresenta√ß√£o de Proposta',
        'would_create' => 'Google Calendar Event'
    ];
}

/**
 * Testa apenas extra√ß√£o OpenAI
 */
function testOpenAIExtraction() {
    $transcript = "Cliente: Nossa empresa precisa urgentemente de um novo sistema. Nossos custos est√£o altos demais e a produtividade est√° baixa. Vendedor: Entendo. Qual o or√ßamento dispon√≠vel? Cliente: Temos R$ 50.000 para investir.";
    
    $result = extractDataWithOpenAI($transcript);
    
    zenSuccess($result, 'Teste OpenAI conclu√≠do');
}

/**
 * Testa apenas integra√ß√£o Bitrix24
 */
function testBitrixUpdate() {
    $entity = ['type' => 'lead', 'id' => 12345];
    $data = [
        'TITLE' => 'Teste ZenScribe',
        'COMMENTS' => 'Teste de integra√ß√£o autom√°tica'
    ];
    
    $result = simulateBitrixUpdate($entity, $data, [], '');
    
    zenSuccess($result, 'Teste Bitrix24 conclu√≠do');
}

/**
 * Extrai dados usando OpenAI (fun√ß√£o real)
 */
function extractDataWithOpenAI($transcript) {
    $config = getZenScribeConfig();
    
    if (empty($config['openai']['api_key'])) {
        throw new Exception('OpenAI n√£o configurado');
    }
    
    $prompt = "Analise esta transcri√ß√£o de reuni√£o comercial e extraia:

1. DORES (4 principais dores do cliente, m√°ximo 280 caracteres cada)
2. DESEJOS (5 principais desejos, t√≠tulo + 3 linhas de 50 caracteres)
3. ESTIMATIVA (tabela em horas baseada nas sugest√µes do vendedor)
4. ESCOPO NEGATIVO (o que N√ÉO est√° inclu√≠do)

Transcri√ß√£o:
$transcript

Retorne em formato JSON estruturado.";
    
    $data = [
        'model' => $config['openai']['model'],
        'messages' => [
            ['role' => 'system', 'content' => 'Voc√™ √© um especialista em an√°lise de reuni√µes comerciais B2B.'],
            ['role' => 'user', 'content' => $prompt]
        ],
        'max_tokens' => 1500,
        'temperature' => 0.3
    ];
    
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, 'https://api.openai.com/v1/chat/completions');
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        'Authorization: Bearer ' . $config['openai']['api_key'],
        'Content-Type: application/json'
    ]);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    if ($httpCode !== 200) {
        throw new Exception('OpenAI API falhou: ' . $response);
    }
    
    $result = json_decode($response, true);
    $content = $result['choices'][0]['message']['content'] ?? '';
    
    // Tentar parsear JSON da resposta
    $extracted = json_decode($content, true);
    
    if (!$extracted) {
        // Se n√£o for JSON v√°lido, processar como texto
        $extracted = [
            'ai_processed' => true,
            'raw_response' => $content,
            'TITLE' => 'Reuni√£o Comercial Processada',
            'COMMENTS' => $content
        ];
    } else {
        $extracted['ai_processed'] = true;
    }
    
    zenLog('ü§ñ OpenAI extra√ß√£o conclu√≠da', 'info', [
        'input_length' => strlen($transcript),
        'output_length' => strlen($content)
    ]);
    
    return $extracted;
}

/**
 * Detecta entidade Bitrix24 da descri√ß√£o
 */
function detectBitrixEntity($description) {
    // Regex para URLs do Bitrix24
    $pattern = '/https?:\/\/[^\/]+\.bitrix24\.com\.br\/crm\/(lead|deal|contact|company)\/details\/(\d+)/i';
    
    if (preg_match($pattern, $description, $matches)) {
        return [
            'type' => strtolower($matches[1]),
            'id' => (int)$matches[2],
            'source' => 'url_detection'
        ];
    }
    
    // Padr√µes alternativos (Lead #123, ID: 456)
    if (preg_match('/(?:lead|neg√≥cio|contato)\s*#?(\d+)/i', $description, $matches)) {
        return [
            'type' => 'lead', // padr√£o
            'id' => (int)$matches[1],
            'source' => 'pattern_detection'
        ];
    }
    
    return null;
}
?>
